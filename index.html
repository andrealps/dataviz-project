<!DOCTYPE html>
<html>

<!-- In the HEAD section we have the external resources and dependencies -->

<head>
    <!-- Here we define the set of characters we use -->
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <!-- For phone -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Here we get the D3 javascript library  -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/d3/4.8.0/d3.min.js"></script>
    <!-- Here we get the common styles that apply to similar elements -->
    <link type="text/css" rel="stylesheet" href="./project.css">
    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Lora&display=swap" rel="stylesheet">
</head>

<body>
    <!-- This is the box where the title is -->
    <div class="header">

    </div>

    <div class="container">
        <div class="row">
            <!-- This is the box where the timeline is -->
            <div class="col-sm-4" id="timeline-container">
                Timeline dataviz
            </div>
            <!-- This is the box where the snake is -->
            <div class="col-sm-8" id="snake-container">
            </div>
        </div>
    </div>

    <!-- Here goes the javascript bit with the D3.js code -->
    <script type="text/javascript">
        // ************************************************************ VARIABLES
        var width_snake = "100%"; // width of snake-svg
        var height_snake = "600"; // height of snake-svg
        var snake_path_data =
            "m 585 900 h 315 c 13.725 -0.046 33.518 3.347 36.346 31.058 c 2.262 10.745 -3.959 38.456 -29 38 h -301 c -30 0 -45 15 -45 45 c 0 30 30 30 30 30 h 3 h 315 c 13.725 -0.046 33.518 3.347 36.346 31.058 c 2.262 10.745 -3.959 38.456 -29 38 h -301 c -30 0 -45 15 -45 45 c 0 30 30 30 30 30 h 3 H 955.167";
        var line; // path line to split

        // Variables to split snake
        var numConcepts = 14; // number of concepts in the snake
        var snakeLength; // length of the snake
        var sampleInterval = .25;
        var cumu = 0;

        var colors = d3.scaleOrdinal().range(["#D44A6F", "#E67962", "#FDCB5B", "#80C0A1", "#5F8F78",
            "#53B9C9", "#0086B2", "#8B6391", "#667981"
        ]); // Empathy colors
        var path = d3.line().curve(d3.curveCardinal);

        // Snake path data
        var snake_svg = d3.select("#snake-container").append("svg").attr("id", "svg-snake")
            .attr("width", width_snake).attr("height", height_snake); // Snake svg
        var snake_color_lines = snake_svg.append("g").attr("id", "group-snake-colors");

        // ************************************************************ DRAW
        showSnakePath();


        showLine(function () {
            var pieces = splitPath();

            var pts = [];

            pieces.forEach(function (x) {
                x.segs.forEach(function (seg, i) {
                    if (i > 0 && i % 2 === 0) {
                        pts.push({
                            id: x.id,
                            seg: seg
                        });
                    }
                });
            });

            drawSegments(pieces);
        });

        // ************************************************************ FUNCTIONS
        // Show snake path
        function showSnakePath() {
            line = snake_svg.append("path")
                .attr("id", "snake-path")
                .attr("d", snake_path_data);

            snakeLength = line.node().getTotalLength(); // set snakeLength
        }

        // Split snake path into multiple pieces
        function splitPath() {
            var pieceSizes = [],
                pieces = [];

            for (var i = 0; i < numConcepts; i++) {
                pieceSizes.push({
                    i: i,
                    size: numConcepts
                });
            }

            var size = pieceSizes.reduce(function (a, b) {
                return a + b.size;
            }, 0);

            var pieceSize = snakeLength / size;

            pieceSizes.forEach(function (x, j) {
                var segs = [];
                for (var i = 0; i <= x.size + sampleInterval; i += sampleInterval) {
                    pt = line.node().getPointAtLength((i * pieceSize) + (cumu * pieceSize));
                    segs.push([pt.x, pt.y]);
                }
                angle = Math.atan2(segs[1][1] - segs[0][1], segs[1][0] - segs[0][0]) * 180 / Math.PI;
                pieces.push({
                    id: j,
                    segs: segs,
                    angle: angle
                });
                cumu += x.size;
            });

            return pieces;
        }

        function showLine(callback) {
            line.classed("hidden", false)
                .attr("stroke-dasharray", snakeLength + " " + snakeLength)
                .attr("stroke-dashoffset", snakeLength)
                .transition()
                .duration(1500)
                .ease(d3.easeLinear)
                .attr("stroke-dashoffset", 0)
                .on("end", function () {
                    callback();
                });
        }


        function drawSegments(pieces) {
            var lines = snake_color_lines.selectAll("path.piece")
                .data(pieces)
                .enter().append("path")
                .attr("class", "piece")
                .attr("d", function (d, i) {
                    return path(d.segs);
                });


            lines.transition()
                .duration(0)
                .delay(function (d, i) {
                    return i * 250;
                })
                .style("stroke", function (d, i) {
                    return colors(i);
                });
        }
    </script>

</body>

</html>